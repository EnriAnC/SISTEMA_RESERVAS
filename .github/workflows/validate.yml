# Workflow de ValidaciÃ³n de Archivos
# Valida sintaxis de Docker, Kubernetes, YAML y Markdown

name: âœ… Validation Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1: ValidaciÃ³n de Dockerfiles
  validate-docker:
    name: ğŸ³ Validar Dockerfiles
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    # Instalar hadolint para validar Dockerfiles
    - name: ğŸ”§ Instalar Hadolint
      run: |
        wget -O hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
        chmod +x hadolint
        sudo mv hadolint /usr/local/bin/
        
    - name: ğŸ” Validar Dockerfiles de servicios
      run: |
        echo "ğŸ³ Validando Dockerfiles..."
        
        # Lista de Dockerfiles a validar
        dockerfiles=(
          "services/user-service/Dockerfile"
          "services/resource-service/Dockerfile"
          "services/booking-service/Dockerfile"
          "services/notification-service/Dockerfile"
          "api-gateway/Dockerfile"
        )
        
        error_count=0
        
        for dockerfile in "${dockerfiles[@]}"; do
          if [ -f "$dockerfile" ]; then
            echo "ğŸ” Validando $dockerfile..."
            if hadolint "$dockerfile"; then
              echo "âœ… $dockerfile es vÃ¡lido"
            else
              echo "âŒ $dockerfile tiene errores"
              error_count=$((error_count + 1))
            fi
          else
            echo "âš ï¸ $dockerfile no encontrado"
          fi
          echo "---"
        done
        
        if [ $error_count -gt 0 ]; then
          echo "âŒ Se encontraron $error_count errores en Dockerfiles"
          exit 1
        else
          echo "ğŸ‰ Todos los Dockerfiles son vÃ¡lidos"
        fi

  # Job 2: ValidaciÃ³n de archivos YAML (Kubernetes y Docker Compose)
  validate-yaml:
    name: ğŸ“„ Validar YAML
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    # Instalar yamllint para validar sintaxis YAML
    - name: ğŸ”§ Instalar yamllint
      run: |
        sudo apt-get update
        sudo apt-get install -y yamllint
        
    # Crear configuraciÃ³n de yamllint
    - name: âš™ï¸ Configurar yamllint
      run: |
        cat > .yamllint.yml << EOF
        extends: default
        rules:
          line-length:
            max: 120
          indentation:
            spaces: 2
          trailing-spaces: enable
          empty-lines:
            max-end: 1
          comments:
            min-spaces-from-content: 1
        EOF
        
    - name: ğŸ” Validar archivos Kubernetes
      run: |
        echo "â˜¸ï¸ Validando manifiestos de Kubernetes..."
        
        # Habilita set -e para que el script falle inmediatamente si un comando falla
        # y pipefail para que el error en una tuberÃ­a sea el del comando que falla.
        set -eo pipefail
        
        error_found=false
        
        if [ -d "kubernetes" ]; then
          find kubernetes -name "*.yaml" -o -name "*.yml" | while read -r file; do
            echo "ğŸ” Validando $file..."
            # Captura la salida de yamllint (tanto stdout como stderr)
            if output=$(yamllint -c .yamllint.yml "$file" 2>&1); then
              echo "âœ… $file es vÃ¡lido"
            else
              echo "âŒ $file tiene errores de sintaxis:"
              echo "$output" # <--- Â¡AquÃ­ se imprime el error detallado de yamllint!
              error_found=true
              # No hacemos 'exit 1' dentro del bucle para que intente validar todos los archivos
            fi
          done
        else
          echo "âš ï¸ Directorio kubernetes no encontrado"
          error_found=true # Si no se encuentra el directorio, considÃ©ralo un error
        fi
        
        # DespuÃ©s de validar todos los archivos, si se encontrÃ³ algÃºn error, falla el paso.
        if [ "$error_found" = true ]; then
          echo "âŒ Se encontraron errores de sintaxis en archivos Kubernetes."
          exit 1
        else
          echo "ğŸ‰ Todos los manifiestos de Kubernetes son vÃ¡lidos."
        fi
        
    - name: ğŸ” Validar docker-compose.yml
      run: |
        echo "ğŸ³ Validando docker-compose.yml..."
        
        compose_files=(
          "infrastructure/docker-compose.yml"
          "docker-compose.yml"
        )
        
        for compose_file in "${compose_files[@]}"; do
          if [ -f "$compose_file" ]; then
            echo "ğŸ” Validando $compose_file..."
            if yamllint -c .yamllint.yml "$compose_file"; then
              echo "âœ… $compose_file es vÃ¡lido"
            else
              echo "âŒ $compose_file tiene errores de sintaxis"
              exit 1
            fi
          fi
        done
        
    # Validar sintaxis de Docker Compose con docker-compose
    - name: ğŸ³ Validar sintaxis Docker Compose
      run: |
        set -eo pipefail # AÃ±ade esto para un mejor manejo de errores en scripts
        
        if [ -f "infrastructure/docker-compose.yml" ]; then
          echo "ğŸ” Validando sintaxis de Docker Compose en infrastructure/docker-compose.yml..."
          cd infrastructure
          # Usa 'docker compose' (sin guion) que es la forma moderna
          if docker compose config > /dev/null 2>&1; then # <--- CAMBIO AQUÃ: docker compose en vez de docker-compose
            echo "âœ… docker-compose.yml tiene sintaxis vÃ¡lida"
          else
            echo "âŒ docker-compose.yml tiene errores de sintaxis Docker Compose"
            docker compose config # Muestra los errores de configuraciÃ³n
            exit 1
          fi
          cd .. # Vuelve al directorio raÃ­z
        fi
        
        if [ -f "docker-compose.yml" ]; then # Si tienes un docker-compose.yml en la raÃ­z tambiÃ©n
          echo "ğŸ” Validando sintaxis de Docker Compose en docker-compose.yml..."
          if docker compose config > /dev/null 2>&1; then # <--- CAMBIO AQUÃ
            echo "âœ… docker-compose.yml tiene sintaxis vÃ¡lida"
          else
            echo "âŒ docker-compose.yml tiene errores de sintaxis Docker Compose"
            docker compose config
            exit 1
          fi
        fi

  # Job 3: ValidaciÃ³n de archivos Markdown
  validate-markdown:
    name: ğŸ“ Validar Markdown
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Instalar markdownlint
      run: |
        npm install -g markdownlint-cli
        
    # Crear configuraciÃ³n para markdownlint
    - name: âš™ï¸ Configurar markdownlint
      run: |
        cat > .markdownlint.json << EOF
        {
          "MD013": {
            "line_length": 120,
            "tables": false
          },
          "MD033": false,
          "MD041": false
        }
        EOF
        
    - name: ğŸ” Validar archivos Markdown
      run: |
        echo "ğŸ“ Validando archivos Markdown..."
        
        # Encontrar todos los archivos .md
        find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" | while read -r file; do
          echo "ğŸ” Validando $file..."
          if markdownlint -c .markdownlint.json "$file"; then
            echo "âœ… $file es vÃ¡lido"
          else
            echo "âŒ $file tiene errores de formato"
            exit 1
          fi
        done
        
        echo "ğŸ‰ Todos los archivos Markdown son vÃ¡lidos"

  # Job 4: ValidaciÃ³n de archivos JSON
  validate-json:
    name: ğŸ”§ Validar JSON
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ” Validar archivos JSON
      run: |
        echo "ğŸ”§ Validando archivos JSON..."
        
        # Encontrar y validar archivos JSON
        find . -name "*.json" -not -path "./node_modules/*" -not -path "./.git/*" | while read -r file; do
          echo "ğŸ” Validando $file..."
          if python3 -m json.tool "$file" > /dev/null 2>&1; then
            echo "âœ… $file es vÃ¡lido"
          else
            echo "âŒ $file tiene errores de sintaxis JSON"
            python3 -m json.tool "$file"
            exit 1
          fi
        done
        
        echo "ğŸ‰ Todos los archivos JSON son vÃ¡lidos"

  # Job 5: ValidaciÃ³n de scripts bash
  validate-scripts:
    name: ğŸ”¨ Validar Scripts
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Instalar ShellCheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck
        
    - name: ğŸ” Validar scripts bash
      run: |
        echo "ğŸ”¨ Validando scripts bash..."
        
        if [ -d "scripts" ]; then
          find scripts -name "*.sh" | while read -r script; do
            echo "ğŸ” Validando $script..."
            if shellcheck "$script"; then
              echo "âœ… $script es vÃ¡lido"
            else
              echo "âŒ $script tiene errores"
              exit 1
            fi
          done
        else
          echo "âš ï¸ Directorio scripts no encontrado"
        fi
        
        echo "ğŸ‰ Todos los scripts son vÃ¡lidos"
