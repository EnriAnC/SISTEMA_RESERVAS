# Workflow de AnÃ¡lisis de Seguridad
# Detecta vulnerabilidades y problemas de seguridad en el cÃ³digo

name: ðŸ”’ Security Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Ejecutar anÃ¡lisis de seguridad semanalmente (lunes a las 2 AM UTC)
    - cron: '0 2 * * 1'

jobs:
  # Job 1: AnÃ¡lisis de vulnerabilidades en cÃ³digo Go con gosec
  gosec-analysis:
    name: ðŸ” AnÃ¡lisis gosec
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ¹ Configurar Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: ðŸ”§ Instalar gosec
      run: |
        curl -sfL https://raw.githubusercontent.com/securecodewarrior/gosec/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v2.18.2
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
        
    - name: ðŸ” Ejecutar gosec en todos los servicios
      run: |
        echo "ðŸ”’ Ejecutando anÃ¡lisis de seguridad con gosec..."
        
        services=("user-service" "resource-service" "booking-service" "notification-service")
        overall_issues=0
        
        for service in "${services[@]}"; do
          echo "ðŸ” Analizando $service..."
          cd "services/$service"
          
          # Ejecutar gosec y capturar el cÃ³digo de salida
          if gosec -fmt json -out gosec-report.json ./...; then
            echo "âœ… $service: Sin problemas crÃ­ticos de seguridad"
          else
            echo "âš ï¸ $service: Se encontraron problemas de seguridad"
            # Mostrar resumen de problemas encontrados
            gosec -fmt text ./... || true
            overall_issues=$((overall_issues + 1))
          fi
          
          cd ../..
          echo "---"
        done
        
        if [ $overall_issues -gt 0 ]; then
          echo "âŒ Se encontraron problemas de seguridad en $overall_issues servicios"
          echo "ðŸ“ Revisa los reportes generados para mÃ¡s detalles"
          exit 1
        else
          echo "ðŸŽ‰ AnÃ¡lisis de seguridad completado sin problemas crÃ­ticos"
        fi

  # Job 2: Escaneo de dependencias vulnerables
  dependency-scan:
    name: ðŸ“¦ Escaneo Dependencias
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ¹ Configurar Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: ðŸ”§ Instalar govulncheck
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        
    - name: ðŸ” Escanear vulnerabilidades en dependencias
      run: |
        echo "ðŸ“¦ Escaneando vulnerabilidades en dependencias..."
        
        services=("user-service" "resource-service" "booking-service" "notification-service")
        vulnerable_services=0
        
        for service in "${services[@]}"; do
          echo "ðŸ” Escaneando dependencias de $service..."
          cd "services/$service"
          
          if govulncheck ./...; then
            echo "âœ… $service: Sin vulnerabilidades conocidas en dependencias"
          else
            echo "âš ï¸ $service: Se encontraron vulnerabilidades en dependencias"
            vulnerable_services=$((vulnerable_services + 1))
          fi
          
          cd ../..
          echo "---"
        done
        
        if [ $vulnerable_services -gt 0 ]; then
          echo "âŒ Se encontraron vulnerabilidades en $vulnerable_services servicios"
          echo "ðŸ”§ Actualiza las dependencias vulnerables identificadas"
          exit 1
        else
          echo "ðŸŽ‰ Escaneo de dependencias completado sin vulnerabilidades"
        fi

  # Job 3: DetecciÃ³n de secretos hardcodeados
  secret-scan:
    name: ðŸ” Detectar Secretos
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Instalar truffleHog
      run: |
        curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
        
    - name: ðŸ” Escanear secretos en el cÃ³digo
      run: |
        echo "ðŸ” Escaneando secretos hardcodeados..."
        
        # Ejecutar truffleHog para detectar secretos
        if truffleHog filesystem . --exclude-paths .github/workflows/security.yml; then
          echo "âœ… No se encontraron secretos hardcodeados"
        else
          echo "âŒ Se encontraron posibles secretos hardcodeados"
          echo "ðŸ”§ Revisa y remueve cualquier credencial del cÃ³digo fuente"
          exit 1
        fi

  # Job 4: AnÃ¡lisis de configuraciÃ³n de seguridad
  security-config:
    name: âš™ï¸ ConfiguraciÃ³n Seguridad
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ” Verificar configuraciones de seguridad
      run: |
        echo "âš™ï¸ Verificando configuraciones de seguridad..."
        
        security_issues=0
        
        # Verificar que no hay contraseÃ±as por defecto en docker-compose
        echo "ðŸ” Verificando docker-compose.yml..."
        if [ -f "infrastructure/docker-compose.yml" ]; then
          if grep -i "password.*password\|password.*123\|password.*admin" infrastructure/docker-compose.yml; then
            echo "âŒ Se encontraron contraseÃ±as por defecto en docker-compose.yml"
            security_issues=$((security_issues + 1))
          else
            echo "âœ… docker-compose.yml no contiene contraseÃ±as por defecto obvias"
          fi
        fi
        
        # Verificar configuraciones de Kubernetes
        echo "ðŸ” Verificando manifiestos de Kubernetes..."
        if [ -d "kubernetes" ]; then
          # Buscar configuraciones inseguras comunes
          if find kubernetes -name "*.yaml" -exec grep -l "privileged.*true\|runAsUser.*0\|allowPrivilegeEscalation.*true" {} \; | head -1; then
            echo "âŒ Se encontraron configuraciones privilegiadas en Kubernetes"
            security_issues=$((security_issues + 1))
          else
            echo "âœ… No se encontraron configuraciones privilegiadas obvias"
          fi
        fi
        
        # Verificar que los Dockerfiles no ejecutan como root
        echo "ðŸ” Verificando Dockerfiles..."
        dockerfile_issues=0
        find . -name "Dockerfile" | while read -r dockerfile; do
          if ! grep -q "USER " "$dockerfile"; then
            echo "âš ï¸ $dockerfile no especifica USER (ejecutarÃ¡ como root)"
            dockerfile_issues=$((dockerfile_issues + 1))
          fi
        done
        
        # Verificar archivos con permisos sensibles
        echo "ðŸ” Verificando permisos de archivos..."
        if find scripts -name "*.sh" -perm /111 2>/dev/null | grep -q .; then
          echo "âœ… Scripts tienen permisos de ejecuciÃ³n"
        else
          echo "âš ï¸ Algunos scripts pueden necesitar permisos de ejecuciÃ³n"
        fi
        
        if [ $security_issues -gt 0 ]; then
          echo "âŒ Se encontraron $security_issues problemas de configuraciÃ³n de seguridad"
          echo "ðŸ”§ Revisa y corrige las configuraciones marcadas como inseguras"
          exit 1
        else
          echo "ðŸŽ‰ Configuraciones de seguridad verificadas correctamente"
        fi

  # Job 5: Generar reporte de seguridad
  security-report:
    name: ðŸ“Š Reporte Seguridad
    runs-on: ubuntu-latest
    needs: [gosec-analysis, dependency-scan, secret-scan, security-config]
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ“Š Generar reporte de seguridad
      run: |
        echo "ðŸ“Š Generando reporte de seguridad..."
        
        cat > security-report.md << EOF
        # ðŸ”’ Reporte de Seguridad
        
        **Fecha:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Commit:** ${{ github.sha }}
        **Branch:** ${{ github.ref_name }}
        
        ## ðŸ“‹ Resumen de AnÃ¡lisis
        
        - âœ… AnÃ¡lisis de cÃ³digo (gosec)
        - âœ… Escaneo de dependencias (govulncheck)  
        - âœ… DetecciÃ³n de secretos (truffleHog)
        - âœ… ConfiguraciÃ³n de seguridad
        
        ## ðŸ” Servicios Analizados
        
        - user-service
        - resource-service
        - booking-service
        - notification-service
        
        ## ðŸ“ Recomendaciones
        
        1. Mantener dependencias actualizadas
        2. Revisar configuraciones de despliegue
        3. Usar secretos de Kubernetes/Docker para credenciales
        4. Ejecutar contenedores con usuarios no-root
        5. Habilitar escaneos de seguridad automÃ¡ticos
        
        ---
        *Reporte generado automÃ¡ticamente por GitHub Actions*
        EOF
        
        echo "ðŸ“„ Reporte de seguridad generado:"
        cat security-report.md
        
    # Subir reporte como artefacto
    - name: ðŸ“¤ Subir reporte como artefacto
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: security-report.md
        retention-days: 30
